<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titan LFG</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
            margin-top: 20px;
            color: #333;
        }
        /* Auth Form Styles */
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        .auth-form input, .auth-form textarea, .auth-form button {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            box-sizing: border-box;
        }
        .auth-form button {
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        .auth-form button:hover {
            background-color: #0056b3;
        }
        /* Main Content Styles */
        #mainContent {
            display: none; /* Hidden initially */
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        #groups {
            margin-top: 20px;
        }
        .group-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .group-item:last-child {
            border-bottom: none;
        }
        /* Profile Page Styles */
        #profileContent {
            display: none; /* Hidden initially */
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        /* Background Music */
        #backgroundMusic {
            display: none; /* Hidden in the UI */
        }
    </style>
</head>
<body>
    <h1>Titan LFG</h1>

    <!-- Authentication Forms -->
    <div class="auth-form" id="authForm">
        <div id="registerForm">
            <h2>Register</h2>
            <input type="text" id="registerUsername" placeholder="Username" required />
            <input type="email" id="registerEmail" placeholder="Email" required />
            <input type="password" id="registerPassword" placeholder="Password" required />
            <button type="button" onclick="register()">Register</button>
        </div>
        <div id="loginForm" style="display: none;">
            <h2>Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required />
            <input type="password" id="loginPassword" placeholder="Password" required />
            <label>
                <input type="checkbox" id="rememberMe" /> Remember Me
            </label>
            <button type="button" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Main content for group creation -->
    <div id="mainContent">
        <form id="lfgForm">
            <label for="game">Game:</label>
            <input type="text" id="game" placeholder="Game Name" required />
            
            <label for="description">Description:</label>
            <textarea id="description" placeholder="Description" required></textarea>
            
            <button type="submit">Create Group</button>
        </form>

        <!-- Recently created groups list -->
        <div id="groups">
            <h2>Recently Created Groups</h2>
            <!-- Groups will be listed here -->
        </div>
    </div>

    <!-- Profile page -->
    <div id="profileContent">
        <h2>Profile</h2>
        <p id="usernameDisplay"></p>
        <p id="emailDisplay"></p>
        <button type="button" onclick="logout()">Logout</button>
    </div>

    <!-- Background music -->
    <audio id="backgroundMusic" autoplay loop>
        <source src="background-music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkXMlEkORvvfH-kBYbBLAfasBoCsHCQmQ",
            authDomain: "titan1lfg.firebaseapp.com",
            projectId: "titan1lfg",
            storageBucket: "titan1lfg.appspot.com",
            messagingSenderId: "51631664886",
            appId: "1:51631664886:web:1f9660b9a81b3c945446d7",
            measurementId: "G-VG05N7CS55"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.register = async function() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const username = document.getElementById('registerUsername').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, 'users', user.uid), {
                    email: user.email,
                    username: username
                });

                alert('Registration successful!');
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('profileContent').style.display = 'none';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        window.login = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.data();

                document.getElementById('usernameDisplay').textContent = `Username: ${userData.username}`;
                document.getElementById('emailDisplay').textContent = `Email: ${user.email}`;

                if (rememberMe) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                alert('Login successful!');
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('profileContent').style.display = 'block';
                document.getElementById('authForm').style.display = 'none';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        window.logout = async function() {
            try {
                await signOut(auth);
                alert('Logged out successfully!');
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('profileContent').style.display = 'none';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        window.createGroup = async function() {
            const missionType = document.getElementById('missionType').value;
            const missionLevel = document.getElementById('missionLevel').value;
            const user = auth.currentUser;

            if (user) {
                try {
                    await addDoc(collection(db, 'groups'), {
                        missionType: missionType,
                        missionLevel: missionLevel,
                        user: user.email,
                        createdAt: new Date()
                    });
                    alert('Group created successfully!');
                    displayGroups();
                } catch (e) {
                    alert('Error adding group: ' + e.message);
                }
            } else {
                alert('You must be logged in to create a group.');
            }
        }

        function displayGroups() {
            const q = query(collection(db, 'groups'), orderBy('createdAt', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                const groupList = document.getElementById('groupList');
                groupList.innerHTML = '<h2>Recently Created Groups</h2>';
                snapshot.forEach((doc) => {
                    const groupData = doc.data();
                    const div = document.createElement('div');
                    div.className = 'group-item';
                    div.textContent = `Mission Type: ${groupData.missionType}, Level: ${groupData.missionLevel}, Created By: ${groupData.user}`;
                    groupList.appendChild(div);
                });
            });
        }

        window.updateLevels = function() {
            const missionType = document.getElementById('missionType').value;
            const missionLevel = document.getElementById('missionLevel');
            missionLevel.innerHTML = '';

            if (levels[missionType]) {
                levels[missionType].forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    missionLevel.appendChild(option);
                });
            }
        }

        const levels = {
            "Void Farming": ['Fire', 'Electric', 'Ice', 'Toxic', 'Non-Attribute'],
            "Calling of the Descendants": [
                'Bio-Lab', 'Caligo Ossuary', 'Heart of the Fortress', 'Magister Lab', 
                'Mystery\'s End', 'Old Mystery', 'Quarantine Zone', 'Seed Vault', 
                'Sepulcher', 'Slumber Valley', 'The Asylum', 'The Chapel', 
                'The Forgottense', 'The Haven', 'The Shelter', 'Unknown Laboratory'
            ],
            "Normal Void Battles": ['Grave Walker', 'Stunning Beauty', 'Executioner', 
                                     'Dead Bride', 'Devourer', 'Pyromaniac', 
                                     'Swamp Walker', 'Hanged Man'],
            "Hard Void Battles": ['Executioner', 'Dead Bride', 'Devourer', 'Pyromaniac', 
                                   'Swamp Walker', 'Obstructor', 'Frost Walker', 
                                   'Molten Fortress'],
            "Encrypted Vaults": ['Vault 1', 'Vault 2', 'Vault 3'],
            "Zone Farming": ['Agna Desert', 'Echo Swamp', 'Fortress', 'Haigos', 
                             'Kingston', 'Sterile Land', 'Vespers', 'White Night Gulch']
        };

        updateLevels();

        window.onload = function() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                document.getElementById('loginEmail').value = rememberedEmail;
                document.getElementById('rememberMe').checked = true;
            }
        };

        displayGroups();

        document.getElementById('lfgForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const game = document.getElementById('game').value;
            const description = document.getElementById('description').value;
            const user = auth.currentUser;

            if (user) {
                try {
                    await addDoc(collection(db, 'lfgGroups'), {
                        game: game,
                        description: description,
                        user: user.email,
                        createdAt: new Date()
                    });

                    alert('Group created successfully!');
                    document.getElementById('lfgForm').reset();
                    displayLFGGroups();
                } catch (e) {
                    alert('Error adding group: ' + e.message);
                }
            } else {
                alert('You must be logged in to create a group.');
            }
        });

        function displayLFGGroups() {
            const q = query(collection(db, 'lfgGroups'), orderBy('createdAt', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                const groupList = document.getElementById('groups');
                groupList.innerHTML = '<h2>Recently Created Groups</h2>';
                snapshot.forEach((doc) => {
                    const groupData = doc.data();
                    const div = document.createElement('div');
                    div.className = 'group-item';
                    div.innerHTML = `<h2>${groupData.game}</h2><p>${groupData.description}</p>`;
                    groupList.appendChild(div);
                });
            });
        }
    </script>
</body>
</html>
