<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LFG Site</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Your existing CSS styles here */
    </style>
</head>
<body>
    <h1>Titan LFG</h1>

    <!-- Authentication Forms -->
    <div class="auth-form" id="authForm">
        <!-- Existing registration and login forms here -->
    </div>

    <!-- Main content for group creation -->
    <div id="mainContent" style="display: none;">
        <form id="lfgForm">
            <label for="game">Game:</label>
            <input type="text" id="game" placeholder="Game Name" required />
            
            <label for="description">Description:</label>
            <textarea id="description" placeholder="Description" required></textarea>
            
            <button type="submit">Create Group</button>
        </form>

        <!-- Recently created groups list -->
        <div id="groups">
            <h2>Recently Created Groups</h2>
            <!-- Groups will be listed here -->
        </div>
    </div>

    <!-- Profile page -->
    <div id="profileContent">
        <!-- Existing profile content here -->
    </div>

    <!-- Background music -->
    <audio id="backgroundMusic" autoplay loop>
        <source src="background-music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDkXMlEkORvvfH-kBYbBLAfasBoCsHCQmQ",
            authDomain: "titan1lfg.firebaseapp.com",
            projectId: "titan1lfg",
            storageBucket: "titan1lfg.appspot.com",
            messagingSenderId: "51631664886",
            appId: "1:51631664886:web:1f9660b9a81b3c945446d7",
            measurementId: "G-VG05N7CS55"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Function to handle registration
        window.register = async function() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const username = document.getElementById('registerUsername').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Save the username in Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    email: user.email,
                    username: username
                });

                alert('Registration successful!');
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('authForm').style.display = 'none';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Function to handle login
        window.login = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Retrieve username from Firestore
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.data();

                // Display username and email
                document.getElementById('usernameDisplay').textContent = `Username: ${userData.username}`;
                document.getElementById('emailDisplay').textContent = `Email: ${user.email}`;
                
                // Handle "Remember Me" functionality
                if (rememberMe) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                alert('Login successful!');
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('profileContent').style.display = 'block';
                document.getElementById('authForm').style.display = 'none';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Function to log out
        window.logout = async function() {
            try {
                await signOut(auth);
                alert('Logged out successfully!');
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('profileContent').style.display = 'none';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Function to create a group
        window.createGroup = async function() {
            const missionType = document.getElementById('missionType').value;
            const missionLevel = document.getElementById('missionLevel').value;
            const user = auth.currentUser;
            if (user) {
                try {
                    await addDoc(collection(db, 'groups'), {
                        missionType: missionType,
                        missionLevel: missionLevel,
                        user: user.email,
                        createdAt: new Date()
                    });
                    alert('Group created successfully!');
                    displayGroups(); // Refresh the list of groups
                } catch (e) {
                    alert('Error adding group: ' + e.message);
                }
            } else {
                alert('You must be logged in to create a group.');
            }
        }

        // Function to display groups
        function displayGroups() {
            const q = query(collection(db, 'groups'), orderBy('createdAt', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                const groupList = document.getElementById('groupList');
                groupList.innerHTML = '<h2>Recently Created Groups</h2>'; // Clear previous entries
                snapshot.forEach((doc) => {
                    const groupData = doc.data();
                    const div = document.createElement('div');
                    div.className = 'group-item';
                    div.textContent = `Mission Type: ${groupData.missionType}, Objective: ${groupData.missionLevel}, Created By: ${groupData.user}`;
                    groupList.appendChild(div);
                });
            });
        }

        // Function to update mission levels based on selected mission type
        window.updateLevels = function() {
            const missionType = document.getElementById('missionType').value;
            const missionLevel = document.getElementById('missionLevel');
            missionLevel.innerHTML = ''; // Clear existing options

            if (levels[missionType]) {
                levels[missionType].forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    missionLevel.appendChild(option);
                });
            }
        }

        // Object storing the different mission types and their respective levels
        const levels = {
            "Void Farming": ['Fire', 'Electric', 'Ice', 'Toxic', 'Non-Attribute'],
            "Calling of the Descendants": [
                'Bio-Lab', 'Caligo Ossuary', 'Heart of the Fortress', 'Magister Lab', 
                'Mystery\'s End', 'Old Mystery', 'Quarantine Zone', 'Seed Vault', 
                'Sepulcher', 'Slumber Valley', 'The Asylum', 'The Chapel', 
                'The Forgottense', 'The Haven', 'The Shelter', 'Unknown Laboratory'
            ],
            "Normal Void Battles": ['Grave Walker', 'Stunning Beauty', 'Executioner', 
                                     'Dead Bride', 'Devourer', 'Pyromaniac', 
                                     'Swamp Walker', 'Hanged Man'],
            "Hard Void Battles": ['Executioner', 'Dead Bride', 'Devourer', 'Pyromaniac', 
                                   'Swamp Walker', 'Obstructor', 'Frost Walker', 
                                   'Molten Fortress'],
            "Encrypted Vaults": ['Vault 1', 'Vault 2', 'Vault 3'], // Placeholder levels
            "Zone Farming": ['Agna Desert', 'Echo Swamp', 'Fortress', 'Haigos', 
                             'Kingston', 'Sterile Land', 'Vespers', 'White Night Gulch']
        };

        // Initialize the mission levels for the default selected mission type
        updateLevels();

        // Check for remembered email and populate field if available
        window.onload = function() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                document.getElementById('loginEmail').value = rememberedEmail;
                document.getElementById('rememberMe').checked = true;
            }
        };

        // Display groups on page load
        displayGroups();

        // Handle LFG form submission
        document.getElementById('lfgForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const game = document.getElementById('game').value;
            const description = document.getElementById('description').value;
            const user = auth.currentUser;

            if (user) {
                try {
                    await addDoc(collection(db, 'lfgGroups'), {
                        game: game,
                        description: description,
                        user: user.email,
                        createdAt: new Date()
                    });

                    alert('Group created successfully!');
                    document.getElementById('lfgForm').reset();
                    displayLFGGroups(); // Refresh the list of LFG groups
                } catch (e) {
                    alert('Error adding group: ' + e.message);
                }
            } else {
                alert('You must be logged in to create a group.');
            }
        });

        // Function to display LFG groups
        function displayLFGGroups() {
            const q = query(collection(db, 'lfgGroups'), orderBy('createdAt', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                const groupList = document.getElementById('groups');
                groupList.innerHTML = '<h2>Recently Created Groups</h2>'; // Clear previous entries
                snapshot.forEach((doc) => {
                    const groupData = doc.data();
                    const div = document.createElement('div');
                    div.className = 'group';
                    div.innerHTML = `<h2>${groupData.game}</h2><p>${groupData.description}</p>`;
                    groupList.appendChild(div);
                });
            });
        }
    </script>
</body>
</html>
